<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Lowlands Playlist Match</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spotify-web-api-js/1.5.2/spotify-web-api.min.js"></script>
</head>
<body class="p-6 space-y-4">
  <button id="login" class="p-3 bg-green-600 text-white rounded">Log in met Spotify</button>
  <div id="tips" class="space-y-1"></div>
  <button id="playlist" class="hidden p-3 bg-blue-600 text-white rounded">Maak playlist</button>

<script>
const clientId = 'da1c172c19894c75b797b761cb2554df';
const redirectUri = 'https://samai3.github.io/LLSoundScout/';
const scopes = 'user-top-read user-library-read playlist-modify-public';
const api = new SpotifyWebApi();

// 1. Inloggen
document.getElementById('login').onclick = async () => {
  const verifier = crypto.randomUUID().replace(/-/g, '');
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
  const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

  sessionStorage.setItem('verifier', verifier);  // NIET localStorage!
  const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
  location.href = authUrl;
};

// 2. Callback na login
window.onload = () => {
  const code = new URLSearchParams(location.search).get('code');
  if (code) {
    main(code);
  }
};

async function main(code) {
  document.getElementById('login').classList.add('hidden');

  const verifier = sessionStorage.getItem('verifier'); // Moet beschikbaar zijn!

  if (!verifier) {
    alert("PKCE-verificatie mislukt. Probeer opnieuw in te loggen.");
    return;
  }

  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: verifier
  });

  const r = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body
  });

  if (!r.ok) {
    const error = await r.text();
    console.error("Token request failed:", error);
    alert("Kon geen toegangstoken verkrijgen. Controleer of redirect URI exact klopt.");
    return;
  }

  const { access_token } = await r.json();
  api.setAccessToken(access_token);

  const lineup = await fetch('./lowlands2025.json').then(r => r.json());

  const top = await api.getMyTopArtists({ limit: 50 });
  const liked = await api.getMySavedTracks({ limit: 50 });
  const fav = new Set([
    ...top.items.map(a => a.name.toLowerCase()),
    ...liked.items.map(t => t.track.artists[0].name.toLowerCase())
  ]);

  const tips = [];
  for (const act of lineup.filter(a => !fav.has(a.toLowerCase()))) {
    const art = await api.searchArtists(act, { limit: 1 });
    if (!art.artists.items.length) continue;
    const artist = art.artists.items[0];
    const overlap = artist.genres.filter(g => top.items.some(f => f.genres.includes(g))).length;
    const tr = await api.searchTracks(`artist:${act}`, { limit: 2 });
    tips.push({
      act,
      genre: artist.genres[0] || 'onbekend',
      overlap,
      uris: tr.tracks.items.map(t => t.uri)
    });
  }

  tips.sort((a, b) => b.overlap - a.overlap);
  const keep = tips.slice(0, 30);

  const list = document.getElementById('tips');
  keep.forEach((t, i) => {
    const li = document.createElement('div');
    li.textContent = `${i + 1}. ${t.act} – ${t.genre} • Deelt genre met jouw favorieten.`;
    list.append(li);
  });

  const uris = keep.flatMap(t => t.uris);
  const plBtn = document.getElementById('playlist');
  plBtn.classList.remove('hidden');
  plBtn.onclick = async () => {
    const me = await api.getMe();
    const pl = await api.createPlaylist(me.id, { name: 'Lowlands-tips 2025' });
    for (let i = 0; i < uris.length; i += 100) {
      await api.addTracksToPlaylist(pl.id, uris.slice(i, i + 100));
    }
    window.open(pl.external_urls.spotify, '_blank');
  };
}
</script>
</body>
</html>
